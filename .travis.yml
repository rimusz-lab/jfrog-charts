sudo: required
dist: trusty

services:
  - docker

env:
  global:
  - CHART_TESTING_IMAGE="gcr.io/kubernetes-charts-ci/chart-testing"
  - CHART_TESTING_TAG="v1.1.0"
  - CHARTS_REPO="https://github.com/rimusz/jfrog-charts"
  - CHANGE_MINIKUBE_NONE_USER=true
  - K8S_VERSION="v1.10.0"
  - MINIKUBE_VERSION="v0.28.2"

before_script:
- sudo apt-get update
- sudo apt-get install -y socat util-linux
# Copy nsenter tool for Ubuntu 14.04 (current travisCI build VM version)
- sudo docker run --rm -v $(pwd):/target jpetazzo/nsenter
- sudo mv -fv nsenter /usr/local/bin/
# Pull chart-testing docker image
- docker pull gcr.io/kubernetes-charts-ci/chart-testing:"${CHART_TESTING_TAG}"

script:
- echo "Run charts-testing linting!"
- ./test/lint-charts.sh
- >
  if cat tmp/lint.log | grep "No chart changes detected" > /dev/null; then
      echo "No chart changes detected, stopping TravisCI pipeline!"
      travis_terminate 0
  fi
- echo "Run charts-testing install in Minikube!"
# ping stdout every 9 minutes or Travis kills build
# https://docs.travis-ci.com/user/common-build-problems/#Build-times-out-because-no-output-was-received
- while sleep 9m; do echo "=====[ $SECONDS seconds still running ]====="; done &
- ./test/e2e-minikube.sh

notifications:
  email: false
